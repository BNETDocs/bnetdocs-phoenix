<?php /* vim: set colorcolumn=: */
namespace BNETDocs\Templates\Document;
use \BNETDocs\Libraries\Document;
use \BNETDocs\Libraries\User;
use \CarlBennett\MVC\Libraries\Common;
use \CarlBennett\MVC\Libraries\Pair;
$title = 'All Documents';
$description = 'This page is an index for all of the document pages on BNETDocs';
$this->opengraph->attach(new Pair('url', '/document/index'));
$order = $this->getContext()->order;
require('./header.inc.phtml'); ?>
<div class="container mb-3">
  <h2><?=$title?></h2>
  <p><?=$description?></p>
  <form method="GET" class="m-2" id="order_by_form">
    <label for="order">Order by:</label>
    <select class="form-control form-control-sm" name="order" id="order" onchange="form.submit();"
      style="display:inline-block;width:200px;">
      <option value="created-asc"<?
        if ($order === 'created-asc') { echo ' selected="selected"';
        } ?>>Created (Ascending)</option>
      <option value="created-desc"<?
        if ($order === 'created-desc') { echo ' selected="selected"';
        } ?>>Created (Descending)</option>
      <option value="id-asc"<?
        if ($order === 'id-asc') { echo ' selected="selected"';
        } ?>>Id (Ascending)</option>
      <option value="id-desc"<?
        if ($order === 'id-desc') { echo ' selected="selected"';
        } ?>>Id (Descending)</option>
      <option value="title-asc"<?
        if ($order === 'title-asc') { echo ' selected="selected"';
        } ?>>Title (Ascending)</option>
      <option value="title-desc"<?
        if ($order === 'title-desc') { echo ' selected="selected"';
        } ?>>Title (Descending)</option>
      <option value="updated-asc"<?
        if ($order === 'updated-asc') { echo ' selected="selected"';
        } ?>>Updated (Ascending)</option>
      <option value="updated-desc"<?
        if ($order === 'updated-desc') { echo ' selected="selected"';
        } ?>>Updated (Descending)</option>
      <option value="user-id-asc"<?
        if ($order === 'user-id-asc') { echo ' selected="selected"';
        } ?>>User Id (Ascending)</option>
      <option value="user-id-desc"<?
        if ($order === 'user-id-desc') { echo ' selected="selected"';
        } ?>>User Id (Descending)</option>
    </select>
    <input class="btn btn-sm btn-secondary" type="submit" value="Reorder"/>
  </form>
  <table class="table table-hover table-striped" id="docs_tbl">
    <thead><tr><th class="left">Document</th><th class="left">Author</th></tr></thead><tbody>
<?  foreach ($this->getContext()->documents as $document)
    {
      $doc_title = filter_var($document->getTitle(), FILTER_SANITIZE_FULL_SPECIAL_CHARS);
      $doc_brief = rtrim(Common::stripUpTo(Common::stripUpTo(trim(filter_var($document->getContent(true), FILTER_SANITIZE_STRING)), "\n", 128), '. ', 128), '.');
      $doc_user = $document->getUser();
      $doc_user_string = ($doc_user ?
        sprintf('<a href="%s"><img class="img-fluid rounded mr-2" src="%s"/>%s</a>',
          $doc_user->getURI(), $doc_user->getAvatarURI(40), filter_var($doc_user->getName(), FILTER_SANITIZE_FULL_SPECIAL_CHARS)
        ) : 'Anonymous'
      );
      echo '<tr><td><strong><a href="' . $document->getURI() . '">' . $doc_title . '</a></strong><br/>'
        . '<span class="text-muted">' . $doc_brief . '</span></td><td>' . $doc_user_string . '</td></tr>';
    } ?>
  </tbody></table>
</div>
<? ob_start(); ?>
  <script type="text/javascript">
    $(document).ready(function(){
      $('#order_by_form').hide();
      $('#docs_tbl').DataTable({
        "language": {"zeroRecords": "No matching documents found"},
        "responsive": true,
      });
    });
  </script>
<? $_footer_script = ob_get_clean(); require('./footer.inc.phtml'); ?>

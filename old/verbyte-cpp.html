<html>
<head>
<link rel="stylesheet" type="text/css" href="http://rafb.net/styles/nopaste.css"/>
<link rel="icon" href="http://rafb.net/nopaste_favicon.gif" type="image/gif"/>
<link rel="shortcut icon" href="http://rafb.net/nopaste_favicon.gif" type="image/gif"/>
<title>BNETDocs: "How to Obtain VerByte" Source Code by DevCode</title>
</head><div style="border-bottom: 2px solid gray;">
<table border="0" cellpadding="1" cellspacing="2" width="100%">
<tr>
  <td><small>File hosted by <a href="http://www.bnetdocs.org">BNETDocs</a></small></td>
</tr>
</table>
</div>

<table border="0" cellpadding="1" cellspacing="2">
<tr>
  <td><pre class="code" style="line-height: 1.2847em;">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112</pre></td>

  <td width="100%"><pre class="code" id="codemain"><span class="comment">/* bncsutil.cpp v1.3.2
 * Copyright (c) 2007 devcode
 *
 *
 *			^^ D E V C O D E ^^
 *
 * Starcraft/Brood Wars Dynamic Verbyte Retrieval
 *
 *
 * Description:
 *	  Obtains the verbyte for Starcraft/Brood Wars given
 *	  the input Starcraft.exe image. 
 *  
 * Tested on:
 * 	  Starcraft 1.08 -> 1.15.1
 *
 * Credits: 
 *	  GameDeception (Pattern finding code)
 *	  DonCullen (Bringing up the idea)
 *
 */</span>
&nbsp;<span class="keyword">
#include</span> &lt;windows.h><span class="keyword">
#include</span> &lt;iostream>
&nbsp;
<span class="comment">/** 
 * Compares the pattern with the data
 * 
 * @param pbData
 * @param pbMask
 * @param szMask
 * 
 * @return bool
 */</span>
<span class="keyword">bool</span> DataCompare( <span class="keyword">const</span> BYTE *pbData, <span class="keyword">const</span> BYTE *pbMask, <span class="keyword">const</span> <span class="keyword">char</span> *szMask ) {
    <span class="keyword">for</span>( ;*szMask; ++szMask,++pbData, ++pbMask )
        <span class="keyword">if</span>( *szMask == <span class="literal">'x'</span> &amp;&amp; *pbData != *pbMask )
            <span class="keyword">return</span> <span class="keyword">false</span>;
    <span class="keyword">return</span> ( *szMask ) == NULL;
}

&nbsp;
<span class="comment">/** 
 * Finds a pattern in memory (shamelessly taken from 
 * gamedeception forums, unknown author) 
 * 
 * @param dwAddress = Start of memory to search
 * @param dwLen = Size of memory to search
 * @param pbMask
 * @param szMask
 * 
 * @return DWORD
 */</span>
DWORD FindPattern( DWORD dwAddress, DWORD dwLen, BYTE *pbMask, <span class="keyword">char</span> *szMask ) {
    <span class="keyword">for</span>( DWORD i=0; i &lt; dwLen; i++ )
        <span class="keyword">if</span>( DataCompare( (BYTE *)( dwAddress+i ), pbMask, szMask ) )
            <span class="keyword">return</span> (DWORD)(dwAddress+i);
	<span class="keyword">return</span> 0;
}

&nbsp;
<span class="comment">/** 
 * Gets version byte for Starcraft/Brood Wars
 * 
 * @param szStarcraftExe = Path to Starcraft.exe
 * 
 * @return DWORD = Returns 0 if function fails, otherwise, the 
 *         	version byte
 */</span>
DWORD GetVersionByte( <span class="keyword">const</span> <span class="keyword">char</span> *szStarcraftExe ) {
	HANDLE hFile, hMappedFile;
	BYTE *pdwImage;
	<span class="keyword">int</span> nRetVal;
	LARGE_INTEGER nSize;
	<span class="comment">/**
	 * mov dword [esi+10h], DWORD &lt;-- VerByte 
	 * mov dword [esi+18h], DWORD 
	 * mov dword [esi+28h], DWORD 
	*/</span>
	BYTE pbPattern[] = <span class="literal">"\xC7\x46\x10\x00\x00\x00\x00\xC7\x46\x18\x00\x00\x00\x00\xC7\x46"</span>;
	DWORD dwResult = 0;

&nbsp;
	<span class="comment">/* Open the file and create read only mapping */</span>
	PRECONDITION( szStarcraftExe );
	hFile = CreateFile( szStarcraftExe, GENERIC_READ, 0, NULL, 
						OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL );
	PRECONDITION( hFile != INVALID_HANDLE_VALUE );
&nbsp;
	hMappedFile = CreateFileMapping( hFile, NULL, PAGE_READONLY, 0, 0, NULL );
	PRECONDITION( hMappedFile );
&nbsp;
	<span class="comment">/* Map the file into memory */</span>
	pdwImage = (BYTE *)MapViewOfFile( hMappedFile, FILE_MAP_READ, 0, 0, 0 );
	PRECONDITION( pdwImage );
&nbsp;
	<span class="comment">/* File size, ditto */</span>

	nRetVal = GetFileSizeEx( hFile, &amp;nSize );
	PRECONDITION( nRetVal );
&nbsp;
	dwResult = FindPattern( (DWORD)pdwImage, nSize.LowPart, pbPattern, <span class="literal">"xxx????xxx????xx"</span> );
	<span class="keyword">if</span> ( dwResult ) dwResult = *((BYTE *)dwResult+3);
&nbsp;
	<span class="comment">/* We're done, unmap the view */</span>
	PRECONDITION( UnmapViewOfFile( pdwImage ) );
	<span class="comment">/* Close all handles */</span>

	PRECONDITION( CloseHandle( hMappedFile ) );
	PRECONDITION( CloseHandle( hFile ) );
	<span class="keyword">return</span> dwResult;
}
&nbsp;
<span class="keyword">int</span> main( ) {
	GetVersionByte( <span class="literal">"C:\\Program Files\\starcraft\\Starcraft.exe"</span> );
}</pre></td>
</tr>
</table>
</html>